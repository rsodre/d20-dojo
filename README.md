# D20 - An on-chain implementation of the D20 system (D&D)

Cartridge AI Hackathon Project

## Features

- Implementation of a complex existing game system.
- Using a subset of the [D20](./D20.md) character classes.
- Made with Claude Code: specification, planning, core contract and client development.
- And Google Antigravity: refactors, manual tasks.

## Gameplay
TODO



## Task Log

The agents were instructed to log here all [TASKS](TASKS.md) they complete. Tasks that are skipped were executed by myself.

1. [x] Install [Dojo skills](https://book.dojoengine.org/overview#ai-assisted-development): `npx skills add dojoengine/book --yes`
2. [x] Create [`.tool-versions`](.tool-versions)
3. [x] Initialize Dojo project: `sozo init contracts` in `packages/`
4. [x] Review and fix SPEC.md: Dojo model syntax, architecture, game logic inconsistencies
5. [x] Apply user feedback: OZ + cairo-nft-combo NFTs, namespace `d2_0_1`, signed integers for D20, extract TASKS.md
6. [x] Task 1.1: Replace starter code — updated namespace to `d20_0_1`, renamed package to `d20`, updated world name/seed, set up new module structure (types, events, models, systems, utils), removed starter models/systems/tests
7. [x] Tasks 1.2-1.4: Implement all enums (12 types in `types.cairo`), explorer models (6 models in `models/explorer.cairo`), and temple/chamber models (7 models in `models/temple.cairo`)
8. [x] Task 1.5: Implement D20 utility module (`utils/d20.cairo`) with VRF dice rolling (`roll_d20`, `roll_dice`), `ability_modifier`, `proficiency_bonus`, `calculate_ac` — plus local VRF interface (`utils/vrf.cairo`) and 30 unit tests (all passing)
9. [x] Tasks 1.6-1.8: Monster stat lookup (7 monsters with full SRD stats), all 6 Dojo events, and complete D20 math unit tests (41 tests passing — all 18 ability scores, proficiency by level, AC combos, monster stats)
10. [x] Tasks 1.9 & 2.1: Confirm `dojo_dev.toml` writer permissions for all 3 contracts; implement `explorer_token` contract with `mint_explorer` (standard array validation, class-based stat/equipment/skill init, sequential ID via `world.uuid()`, all 6 explorer models written, `ExplorerMinted` event emitted) and `rest` (HP restore, spell slot reset, class resource reset)
11. [x] Tasks 2.2 & 2.3: Class-specific skill choice validation (Fighter: 1 from Perception/Acrobatics; Rogue: 2 from Perception/Persuasion/Athletics/Arcana + 2 expertise picks with no duplicates; Wizard: 1 from Perception/Persuasion); `rest` was already implemented in task 2.1
12. [x] Task 2.4: Implement `combat_system` contract — `attack` function with d20 attack roll vs monster AC (nat-1 auto-miss, nat-20 crit with double damage dice), weapon damage roll with ability modifier, HP deduction on `MonsterInstance`, monster death clears `in_combat` flag on `ExplorerPosition`, `CombatResult` event emitted; stub entry points for all other combat actions (tasks 2.5-2.10)
13. [x] Tasks 2.5, 2.6 & 2.7: Monster counter-attack (multiattack support, attack roll vs explorer AC, damage + bonus, explorer death detection); Fighter: Extra Attack at level 5, Champion crit on 19-20 at level 3, `second_wind` heal 1d10+level (once per rest); Rogue: Sneak Attack bonus dice (1d6/2d6/3d6 by level, doubled on crit) added to `attack`, `cunning_action` disengage (level 2+, no counter-attack)
14. [x] Task 2.8: Wizard `cast_spell` — slot consumption per spell level; cantrips: Fire Bolt (attack roll + 1d10, crit 2d10), Mage Hand/Light (utility); 1st: Magic Missile (3×1d4+1 auto-hit), Shield (+5 AC), Sleep (5d8 HP threshold); 2nd: Scorching Ray (3 rays × attack + 2d6), Misty Step (disengage); 3rd: Fireball (8d6, DEX save DC 8+INT+prof for half). `use_item`: HealthPotion heals 2d4+2. Monster counter-attacks after all spells except kills and Misty Step.
15. [x] Task 2.9: `handle_death` fully implemented — sets `is_dead`, clears combat state, reads inventory and writes `FallenExplorer` (weapon, armor, gold, potions, `is_looted=false`) using `ChamberFallenCount` as sequential index, increments `ChamberFallenCount`, zeroes out gold/potions on `ExplorerInventory`, emits `ExplorerDied` event.
16. [x] Task 2.10: `flee` mechanic — contested DEX check (both sides roll d20 + DEX modifier), explorer wins ties; on success clears `in_combat`; on failure monster gets a free counter-attack. No previous_chamber tracking in v1 so disengage replaces physical movement.
17. [x] Task 2.11: Combat unit tests (87 total, all passing) — `Config` model stores VRF address set via `dojo_init`; `MockVrf` deployed in tests via `deploy_syscall` and passed as init calldata; tests cover: second_wind (heals, caps at max HP, marks used, rejects reuse, rejects non-fighters), cunning_action (clears combat, rejects fighters, rejects non-combat), flee (survives, rejects non-combat/dead), attack (deals damage, death flow with FallenExplorer creation), use_item (heals, decrements potions, rejects no-potions), dead-explorer guard rails.
18. [x] Task 3.1: Implement `temple_token` contract skeleton — same ERC-721/cairo-nft-combo structure as `explorer_token`; `ITempleToken` interface with all 8 entry points; `mint_temple` initializes `TempleState` (seed, difficulty, next_chamber_id=2, boss_alive=true); `enter_temple`/`exit_temple` update `ExplorerPosition`; remaining entry points stubbed with 'not yet implemented'; `ERC721ComboHooksTrait` with contract/token metadata hooks; added `TEMPLE_TOKEN_DESCRIPTION`/`TEMPLE_TOKEN_EXTERNAL_LINK` constants
19. [x] Tasks 3.3 & 3.4: `enter_temple` — validates temple exists, explorer is alive (`ExplorerHealth.is_dead`), not in combat; places explorer at chamber_id=1 (overwrites any previous temple position in a single write); initializes `ExplorerTempleProgress` on first visit (preserves existing progress on re-entry). `exit_temple` — validates in a temple and not in combat; clears `temple_id`/`chamber_id` to 0; all stats, inventory, XP, and `ExplorerTempleProgress` are preserved on-chain.
20. [x] Tasks 3.5 & 3.6: `generate_chamber` (internal) — derives chamber type/monster/exits/trap DC from `temple_seed ^ chamber_id` deterministic hash; Yonder Formula boss probability (bps, VRF roll, capped 95%); writes `Chamber`, `MonsterInstance` (if monster/boss), exit stubs, updates `TempleState.boss_chamber_id`, emits `ChamberRevealed`. `open_exit` — validates alive/in-temple/not-in-combat, checks exit_index < exit_count, allocates new chamber ID from `TempleState.next_chamber_id`, calls `generate_chamber`, creates bidirectional `ChamberExit` links, increments `chambers_explored`.
21. [x] Task 3.7: `move_to_chamber` — validates alive, in temple, not in combat, exit_index valid, exit discovered; moves explorer to destination chamber; sets `in_combat=true` + `combat_monster_id=1` if live monster present (Monster or Boss chamber); on Trap entry triggers DEX save vs trap_dc: failed save deals 1d6+yonder/2 damage (overkill sets `is_dead`).
22. [x] Task 3.8: `loot_treasure` — Perception check (d20 + WIS mod + proficiency bonus if trained) in Empty (DC 12) or Treasure (DC 10) chambers only; success awards gold (1d6 × (yonder+1) × difficulty) + potion (on roll ≥15); marks `treasure_looted=true` to prevent repeat looting; fails silently (can retry). Note: `search_chamber` removed — traps fire immediately on `move_to_chamber` entry; loot detection and pickup merged into `loot_treasure`.
23. [x] Tasks 3.9 & 3.10: `disarm_trap` — Rogue: DEX + proficiency (×2 if Acrobatics expertise); others: INT + proficiency if Arcana trained; vs trap_dc; success sets `trap_disarmed=true`; failure triggers trap (DEX save or 1d6+yonder/2 damage). `loot_fallen` — validates fallen_index < ChamberFallenCount, body not already looted, not self-looting; merges dropped weapon/armor/gold/potions into inventory (weapons fill empty slots, armor upgrades from None); marks `is_looted=true`.
24. [x] Task 3.11: XP gain and level-up — `gain_xp` internal helper awards monster `xp_reward` to `ExplorerStats.xp` and `ExplorerTempleProgress.xp_earned`; checks thresholds (L2=300, L3=900, L4=2700, L5=6500); `level_up` increments level, rolls hit die (d10/d8/d6 by class) + CON mod for new max HP, updates Wizard spell slots by level table, emits `LevelUp` event; called after every kill in `attack()` and `cast_spell()` (FireBolt, MagicMissile, Sleep, ScorchingRay, Fireball).
25. [x] Task 3.12: Boss defeat — `check_boss_defeat` internal helper checks if the killed monster's chamber matches `TempleState.boss_chamber_id`; on match: sets `boss_alive = false`, increments `ExplorerStats.temples_conquered`, emits `BossDefeated` event; called after every kill in `attack()` and `cast_spell()`.
26. [x] Task 3.13: `calculate_boss_probability` already implemented in task 3.5 — quadratic yonder component (`effective_yonder² × 50 bps`) + linear XP component (`xp_earned × 2 bps`), gated by `MIN_YONDER=5`, capped at `MAX_PROB=9500 bps` (95%); called inside `generate_chamber` with a VRF roll scaled to 500–10000 bps.
27. [x] Task 3.14: Integration tests (`tests/test_integration.cairo`) — 32 tests covering the full flow: mint_temple/enter_temple/exit_temple, open_exit (chamber generation, back-exit, chambers_explored), move_to_chamber (empty/monster/undiscovered), attack in temple context, XP gain + temple progress on kill, level-up on kill, loot_treasure (marks looted, WIS-boosted guarantee), loot_fallen (item transfer, self-loot guard), boss defeat (boss_alive→false, temples_conquered increment), cross-temple stat carry-over, and three end-to-end flows (fighter/rogue/wizard). All 119 tests passing.
28. [x] Task x.9: VRF-randomized character creation — `mint_explorer` now takes only `class` (Fighter/Rogue/Wizard); stats are assigned from the standard array `[15,14,13,12,10,8]` via a class-biased Fisher-Yates shuffle seeded by VRF (Fighter prefers STR→CON→DEX, Rogue prefers DEX→CON→CHA, Wizard prefers INT→WIS→DEX); skills and Rogue expertise are also randomly picked from valid options; call now requires VRF multicall; all 121 tests passing.
29. [x] Task 4.0: Adapt client specification — removed AI/LLM from client; updated SPEC.md (architecture diagram + Game Client section) and TASKS.md (Day 4 tasks 4.7–4.12 rewritten) to reflect click-based action UI: state display panel + deterministic `getAvailableActions(state)` button list, no natural-language input or narration layer.
30. [x] Task 4.1: Set up client project at `/client` — TypeScript + React + Vite app with `@tanstack/react-query`, `starknet`, `@cartridge/controller`, `@dojoengine/torii-client`; `tsconfig.json` with path aliases, `vite.config.ts` with `@/` alias, placeholder `src/generated/` directory for bindings (task 4.2); `pnpm-workspace.yaml` already includes `client`; `tsc --noEmit` passes clean.
31. [x] Task 4.2: Cartridge controller connect — `src/controller.ts` singleton (`ControllerProvider` with `defaultChainId`/`rpcUrl` from `VITE_CHAIN_ID`/`VITE_RPC_URL` env vars, defaults to SN_MAIN + Cartridge public RPC); `ControllerContext` with `probe()` on mount to restore sessions, `connect`/`disconnect`/`openProfile` actions; `ConnectButton` component: shows "Connect" (with loading state) when disconnected, shows username and opens profile modal when clicked while connected.
32. [x] Task 4.6: Explorer and Temple minting UI — `MintExplorerPanel` (class picker: Fighter/Rogue/Wizard → VRF multicall with `request_random` prepended); `MintTemplePanel` (difficulty picker 1–5 → `mint_temple`); `usePlayerTokens` hook subscribes to player's ERC721 balances via `sdk.subscribeTokenBalance`; `ExplorerList`/`TempleList` display owned tokens; `PlayerTokensProvider` context ensures a single subscription; all components render only when wallet is connected.
33. [x] Task 4.8: Torii gRPC model queries + DojoStore — `useGameModels` hook subscribes to all game model types (ExplorerStats/Health/Combat/Inventory/Position/Skills, TempleState, Chamber/MonsterInstance/ChamberFallenCount/ChamberExit/FallenExplorer/ExplorerTempleProgress) via `useEntityQuery` with wildcard KeysClauses; `useExplorerModels(id)` and `useTempleModels(id)` helpers read from the DojoStore via `useModel`; `ExplorerList` updated to display class emoji, level, HP bar, AC, and XP badges per explorer; `useGameModels` called in `LobbyView` so subscriptions run for all connected-player sessions.
34. [x] Task 4.9: Vite router + `/temple/:templeId` route — installed `react-router-dom` v7; `BrowserRouter` added in `main.tsx`; `App.tsx` refactored into `ConnectedRoutes` with `Routes`/`Route` (lobby at `/`, temple view at `/temple/:templeId`); `TempleView` page (`src/pages/TempleView.tsx`) displays temple state badges (difficulty, boss alive/dead, chamber count, max yonder) and filters the player's explorers by `ExplorerPosition.temple_id` to list who is currently inside; `TempleCard` in `TempleList` now links to `/temple/:id`.
35. [x] Task 4.10: Selectable temples and explorer action buttons — `TempleList` now tracks a selected temple (amber outline + "Selected" badge); each card has a "View →" link for navigation; `ExplorerCard` reads `ExplorerPosition.temple_id` to detect in-temple state, shows "Enter Temple #N" button (when a temple is selected and explorer is not in one) or "Exit Temple" button (when in a temple); both buttons call `useTempleCalls` mutations (`enter_temple` / `exit_temple`) with loading states.
36. [x] Tasks 4.11 & 4.12: Play view + action generator — `src/utils/get-available-actions.ts`: pure `getAvailableActions(ctx)` returns typed `Action[]` (label, contract, entrypoint, calldata, needsVrf) for in-combat (attack, class features, spells, flee) and exploring (open/move exits, loot treasure, disarm trap, loot fallen, exit temple) contexts; `PlayView` page at `/play/:templeId/:explorerId` shows explorer character sheet (stats, inventory, class features, skills), current chamber info (type, yonder, exits with discovery state, monster HP, fallen explorers), and an action panel that executes any action via a single `useExecuteAction` mutation (auto-prepends VRF call when needed); lobby explorer cards show "Play →" amber button when in a temple; `useChamberExits` and `useFallenExplorers` hooks added to `use-chambers.tsx`.
37. [x] Task 5.1: Comprehensive test coverage audit and expansion — analyzed all 4 test files (68 existing tests) for coverage gaps; added 24 new tests across `test_combat_system.cairo` (8 tests: Magic Missile, Shield, Misty Step, Sleep spell casting; non-wizard/dead/no-slots validation; health potion cap; attack-not-in-combat) and `test_integration.cairo` (16 tests: disarm_trap 5 scenarios, trap entry damage 2, exit-during-combat, loot-already-looted, loot-invalid-index, open-exit dead/in-combat, move dead/in-combat, loot-treasure-in-combat, loot-fallen-in-combat, enter-temple-in-combat, re-enter-same-temple, loot-empty-chamber, invalid-exit-index). All 150 tests passing.
38. [x] Task 5.2: Permadeath flow tests — 7 new tests: two-player death-and-loot flow (explorer A dies in combat, explorer B loots body with item transfer verification), multiple fallen bodies in same chamber (distinct indices, both readable), dead explorer cannot loot_treasure, dead explorer cannot loot_fallen, dead explorer cannot use_item, dead NFT position frozen in temple, selective body looting (loot body 1 while body 0 remains unchanged). All 157 tests passing.
39. [x] Task 5.3: Cross-temple flow tests — 6 new tests: level-up carries over (kill in A, verify level/XP/max_hp in B), inventory carries over (gold/potions/weapons/armor), HP damage carries over (no auto-heal on temple entry), per-temple progress isolation (A's chambers_explored/xp_earned independent of B), class resources not reset (second_wind/action_surge stay used), full flow with rest (fight in A → exit → rest → enter B with full HP and reset resources). All 163 tests passing.
40. [x] Task 5.4: Multiplayer tests — 7 new tests: shared exit discovery (A opens exit, B walks through), shared monster kill (A kills, B sees dead monster), shared treasure looted (A loots, B can't re-loot), shared trap disarmed (A disarms, B enters safely), shared monster HP visibility (both read same MonsterInstance), independent chamber generation (A and B open different exits, distinct IDs), independent progress tracking (chambers_explored is per-explorer). All 173 tests passing.
41. [x] Task 5.5: Boss probability (Yonder Formula) tests — 7 new tests: zero below min yonder (depths 0-4), correct values at min yonder (XP-only component), quadratic yonder growth (effective_yonder² × 50 bps), combined yonder+XP addition, 95% cap enforcement (never reaches 100%), progression milestones (0%→1.5%→5%→10.5%→22.5%→44.5%→90%→95%), VRF roll range alignment (d20×500 bps mapping). All 180 tests passing.
